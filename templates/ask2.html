<!DOCTYPE html>
<html data-bs-theme="light" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>DTCM</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="/static/css/bootstrap-icons.min.css"> -->
</head>

<body>
    <div class="px-5">
        <section class="py-4 py-xl-5">
            <div class="container">
                <div class="text-center p-4 p-lg-5">
                    <p class="fw-bold text-primary mb-2">歡迎回來</p>
                    <h1 class="fw-bold mb-4">請再次確認是否有以下症狀（可複選）</h1>
                </div>
            </div>
        </section>

        <div style="height: 2rem; text-align: right;">
        </div>
        <br>
        <div class="w-100 d-flex mb-2">
            <button onclick="clearItems()" id="clear-btn" class="btn btn-secondary" style="display: none;">清除</button>
            &nbsp;<h5 id="cc-list"></h5>
            <button id="nextStep" onclick="nextStep()" class="btn btn-outline-info ms-auto" style="display: none;">下一步</button>
        </div>
        <div>
            {% for k, v in bw.items() %}
            <button class="btn btn-light" id="{{ naming[k] }}" onclick="addItem('{{ k }}', '{{ key }}')"
                data-toggle="tooltip" data-placement="top" title="{{ v }}">{{ k }}</button>
            {% endfor %}
        </div>

        <center><img width="40%" src="static/img/body_pic.png" alt="A picture of the body"></center>

    </div>

    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/bs-init.js"></script>
    <script src="/static/js/jquery-3.7.1.min.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })

        chose = {};
        naming = JSON.parse('{{ naming | tojson | safe }}');

        function addItem(item, type) {
            let truth = [];

            truth.push(item);

            if (naming[item] == undefined) {
                id = "hurt-" + hurtCnt;
                hurtCnt += 1;
            }
            else {
                id = naming[item];
            }

            if (chose[item] != undefined) { // delete
                delete chose[item]
                $('#' + id).attr('class', 'btn btn-light');
            } else {
                chose[item] = truth;
                $('#' + id).attr('class', 'btn btn-dark');
            }

            $('#cc-list').text(Object.keys(chose).sort().join(', '));

            if (Object.keys(chose).length > 0) {
                $("#clear-btn").show();
                $("#nextStep").show();
            }
            else {
                $("#clear-btn").hide();
                $("#nextStep").hide();
            }
        }

        function clearItems() {
            for (let k in chose) {
                $('#' + naming[k]).attr('class', 'btn btn-light');
                delete chose[k];
            }

            $('#cc-list').text('');
            $("#clear-btn").hide();
            $("#nextStep").hide();
        }

        function nextStep() {
            if (Object.keys(chose).length == 0) {
                alert('請選擇主訴');
                return;
            }

            let chose_out = new Set();
            for (let k in chose) {
                for(let i in chose[k]) {
                    chose_out.add(chose[k][i]);
                }
            }
            chose_out = Array.from(chose_out);

            axios.post('/api/ask2', {
                'name': "{{ name }}",
                'dcc': chose_out
            }).then(function (response) {
                if(response.data['message'] == 'ok') {
                    window.location.href = '/ask_res?name={{ name }}';
                }
                else {
                    alert("發生錯誤");
                }
            }).catch(function (error) {
                console.log(error);
            });


            

            // $.ajax({
            //     type: 'POST',
            //     url: '/ask',
            //     data: {
            //         'cc': chose
            //     },
            //     success: function (data) {
            //         window.location.href = '/ask';
            //     }
            // });
        }
    </script>
</body>

</html>